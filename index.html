<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cine de Verano - Primos & Hermanos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee&family=Inter:wght@300;400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
        }

        .font-bungee {
            font-family: 'Bungee', cursive;
        }

        .hero-gradient {
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.2) 0%, rgba(15, 23, 42, 1) 100%),
                        url('https://images.unsplash.com/photo-1595764430585-52114e796126?auto=format&fit=crop&q=80&w=2000');
            background-size: cover;
            background-position: center;
            height: 50vh;
        }

        .movie-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .movie-card:hover {
            transform: translateY(-8px);
            border-color: #eab308;
        }

        .day-tab.active {
            background-color: #eab308;
            color: #000;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input, textarea, select {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            width: 100%;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header / Hero -->
    <header class="relative hero-gradient flex items-center justify-center text-center px-4">
        <div class="z-10 mt-20">
            <h1 class="text-5xl md:text-8xl font-bungee text-yellow-400 drop-shadow-[0_5px_15px_rgba(234,179,8,0.4)] mb-4">
                Cine de Verano
            </h1>
            <p class="text-lg md:text-2xl font-light tracking-[0.2em] uppercase text-slate-200">
                Estrenos bajo las estrellas â¢ Primos y Hermanos
            </p>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-12">
        
        <!-- NavegaciÃ³n de DÃ­as -->
        <section class="mb-12 text-center">
            <div class="flex items-center justify-center space-x-4 overflow-x-auto no-scrollbar pb-4" id="days-nav">
                <!-- DinÃ¡mico -->
            </div>
        </section>

        <!-- Cartelera DinÃ¡mica -->
        <section id="movie-container" class="mb-20 min-h-[400px]">
            <div class="flex items-center mb-8">
                <i class="fas fa-calendar-alt text-3xl text-yellow-500 mr-4"></i>
                <h2 id="current-day-title" class="text-3xl font-bold">Cargando cartelera...</h2>
            </div>
            
            <div id="movies-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- DinÃ¡mico -->
            </div>
        </section>

        <!-- Panel de AdministraciÃ³n -->
        <section class="mb-20 bg-slate-900/80 p-8 rounded-3xl border-2 border-yellow-500/20 shadow-xl">
            <div class="flex items-center mb-8">
                <i class="fas fa-tools text-2xl text-yellow-500 mr-3"></i>
                <h2 class="text-2xl font-bungee text-yellow-500">Panel de Control (Nube)</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                <!-- AÃ±adir DÃ­a -->
                <div>
                    <h3 class="font-bold mb-4 flex items-center"><i class="fas fa-plus-circle mr-2 text-yellow-500"></i> Nuevo DÃ­a</h3>
                    <div class="space-y-3">
                        <input type="text" id="new-day-label" placeholder="Ej: DÃ­a 4 - Lunes">
                        <button id="add-day-btn" class="w-full bg-slate-700 hover:bg-slate-600 py-2 rounded-lg font-bold transition disabled:opacity-50">AÃ±adir DÃ­a</button>
                    </div>
                </div>

                <!-- AÃ±adir PelÃ­cula -->
                <div>
                    <h3 class="font-bold mb-4 flex items-center"><i class="fas fa-film mr-2 text-yellow-500"></i> Nueva PelÃ­cula</h3>
                    <div class="space-y-3">
                        <select id="movie-day-select">
                            <!-- DinÃ¡mico -->
                        </select>
                        <input type="text" id="new-movie-title" placeholder="TÃ­tulo de la pelÃ­cula">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="new-movie-time" placeholder="Hora (ej: 22:00h)">
                            <input type="text" id="new-movie-img" placeholder="URL Imagen">
                        </div>
                        <textarea id="new-movie-desc" placeholder="Breve descripciÃ³n..."></textarea>
                        <button id="add-movie-btn" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black py-2 rounded-lg font-bold transition disabled:opacity-50">AÃ±adir PelÃ­cula</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Kiosko -->
        <section class="bg-slate-800/50 backdrop-blur-sm rounded-3xl p-8 mb-20 border-2 border-dashed border-slate-700">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bungee text-yellow-500">Kiosko de Snacks</h2>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                <div class="p-4 bg-slate-900/50 rounded-2xl"><i class="fas fa-cookie-bite text-3xl text-yellow-600 mb-2"></i><p class="font-bold">Palomitas</p></div>
                <div class="p-4 bg-slate-900/50 rounded-2xl"><i class="fas fa-glass-whiskey text-3xl text-blue-400 mb-2"></i><p class="font-bold">Refrescos</p></div>
                <div class="p-4 bg-slate-900/50 rounded-2xl"><i class="fas fa-ice-cream text-3xl text-pink-400 mb-2"></i><p class="font-bold">Helados</p></div>
                <div class="p-4 bg-slate-900/50 rounded-2xl"><i class="fas fa-pizza-slice text-3xl text-red-500 mb-2"></i><p class="font-bold">Cena</p></div>
            </div>
        </section>

    </main>

    <footer class="py-12 text-center text-slate-500 text-sm border-t border-slate-800 bg-slate-900/30">
        <p>Â© 2024 Cine de Verano - Hecho con â¤ï¸ para la familia</p>
    </footer>

    <!-- NotificaciÃ³n -->
    <div id="notification" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-yellow-500 text-black px-8 py-4 rounded-2xl font-bold shadow-2xl hidden z-50">
        Â¡Voto registrado para <span id="voted-movie-name"></span>! ð¿
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cine-verano-familia';

        let schedule = [];
        let currentDayIndex = 0;
        let currentUser = null;

        // --- AUTHENTICATION (RULE 3) ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                setupRealtimeListener();
            }
        });

        // --- FIRESTORE REALTIME LISTENER (RULE 1) ---
        function setupRealtimeListener() {
            // RUTA FINAL: /artifacts/{appId}/public/data/schedule (6 segmentos exactos)
            // 1: artifacts (coll)
            // 2: appId (doc)
            // 3: public (coll)
            // 4: data (doc)
            // 5: content (coll) <- AÃ±adimos este nivel intermedio
            // 6: main (doc)
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'content', 'main');
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    schedule = docSnap.data().list || [];
                } else {
                    schedule = [{
                        id: 'dia1',
                        label: 'DÃ­a 1 - Viernes',
                        movies: [{ 
                            title: 'Bienvenidos al Cine', 
                            time: '22:00h', 
                            desc: 'Â¡Usa el panel de abajo para aÃ±adir las pelis de este verano!', 
                            img: 'https://images.unsplash.com/photo-1485846234645-a62644f84728?auto=format&fit=crop&q=80&w=800' 
                        }]
                    }];
                    setDoc(docRef, { list: schedule }).catch(e => console.error("Error creating doc:", e));
                }
                renderNav();
                renderMovies();
            }, (error) => {
                console.error("Firestore Error:", error);
            });
        }

        // --- RENDER FUNCTIONS ---
        window.renderNav = function() {
            const nav = document.getElementById('days-nav');
            const select = document.getElementById('movie-day-select');
            if (!nav || !select) return;
            
            nav.innerHTML = schedule.map((day, index) => `
                <button onclick="changeDay(${index})" 
                        class="day-tab px-6 py-2 rounded-full font-bold border-2 border-slate-700 whitespace-nowrap transition-all ${index === currentDayIndex ? 'active' : 'bg-slate-800 text-slate-400 hover:border-yellow-500/50'}">
                    ${day.label}
                </button>
            `).join('');

            select.innerHTML = schedule.map((day, index) => `
                <option value="${index}">${day.label}</option>
            `).join('');
        };

        window.renderMovies = function() {
            const day = schedule[currentDayIndex];
            if (!day) return;
            
            document.getElementById('current-day-title').innerText = day.label;
            const grid = document.getElementById('movies-grid');
            if (!grid) return;
            
            if (!day.movies || day.movies.length === 0) {
                grid.innerHTML = `<p class="col-span-full text-center text-slate-500 py-10">No hay pelÃ­culas aÃ±adidas para este dÃ­a aÃºn.</p>`;
                return;
            }

            grid.innerHTML = day.movies.map((movie) => `
                <div class="movie-card bg-slate-800 rounded-3xl overflow-hidden shadow-2xl border border-slate-700 group">
                    <div class="relative overflow-hidden">
                        <img src="${movie.img || 'https://images.unsplash.com/photo-1485846234645-a62644f84728?auto=format&fit=crop&q=80&w=800'}" alt="${movie.title}" class="w-full h-72 object-cover group-hover:scale-110 transition duration-500">
                        <div class="absolute top-4 left-4 bg-yellow-500 text-black px-3 py-1 rounded-full text-xs font-black uppercase tracking-tighter">
                            ${movie.time}
                        </div>
                    </div>
                    <div class="p-8">
                        <h3 class="text-2xl font-bold mb-2 group-hover:text-yellow-400 transition">${movie.title}</h3>
                        <p class="text-slate-400 text-sm leading-relaxed italic mb-6">"${movie.desc}"</p>
                        <button onclick="vote('${movie.title}', this)" 
                                class="w-full py-4 bg-yellow-500 hover:bg-yellow-400 text-black font-black rounded-2xl transition-all shadow-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-thumbs-up"></i>
                            <span>VOTAR ESTA PELI</span>
                        </button>
                    </div>
                </div>
            `).join('');
        };

        // --- ACTIONS ---
        window.changeDay = (index) => {
            currentDayIndex = index;
            renderNav();
            renderMovies();
        };

        window.addNewDay = async () => {
            if (!currentUser) return;
            const label = document.getElementById('new-day-label').value;
            if (!label) return;
            
            const btn = document.getElementById('add-day-btn');
            btn.disabled = true;

            const newDay = {
                id: 'day_' + Date.now(),
                label: label,
                movies: []
            };
            
            const updatedList = [...schedule, newDay];
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'content', 'main');
            try {
                await setDoc(docRef, { list: updatedList });
                document.getElementById('new-day-label').value = '';
            } catch (e) {
                console.error("Error saving day:", e);
            } finally {
                btn.disabled = false;
            }
        };

        window.addNewMovie = async () => {
            if (!currentUser) return;
            const dayIdx = parseInt(document.getElementById('movie-day-select').value);
            const title = document.getElementById('new-movie-title').value;
            const time = document.getElementById('new-movie-time').value;
            const img = document.getElementById('new-movie-img').value;
            const desc = document.getElementById('new-movie-desc').value;

            if (!title || !time) return;

            const btn = document.getElementById('add-movie-btn');
            btn.disabled = true;

            const newMovie = { title, time, img, desc };
            const updatedSchedule = [...schedule];
            updatedSchedule[dayIdx].movies.push(newMovie);
            
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'content', 'main');
            try {
                await setDoc(docRef, { list: updatedSchedule });
                document.getElementById('new-movie-title').value = '';
                document.getElementById('new-movie-time').value = '';
                document.getElementById('new-movie-img').value = '';
                document.getElementById('new-movie-desc').value = '';
            } catch (e) {
                console.error("Error saving movie:", e);
            } finally {
                btn.disabled = false;
            }
        };

        window.vote = (movieTitle, btn) => {
            const notification = document.getElementById('notification');
            document.getElementById('voted-movie-name').innerText = movieTitle;
            notification.classList.remove('hidden');
            btn.innerHTML = '<i class="fas fa-check"></i> <span>Â¡VOTADO!</span>';
            btn.classList.replace('bg-yellow-500', 'bg-green-500');
            btn.classList.add('text-white');
            btn.disabled = true;
            setTimeout(() => notification.classList.add('hidden'), 3000);
        };

        document.getElementById('add-day-btn').onclick = addNewDay;
        document.getElementById('add-movie-btn').onclick = addNewMovie;

        initAuth();
    </script>
</body>
</html>
