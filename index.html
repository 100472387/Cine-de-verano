<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cine de Verano</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
@import url('https://fonts.googleapis.com/css2?family=Bungee&family=Inter:wght@300;400;700&display=swap');
  body { font-family: 'Inter', sans-serif; background:#0f172a; color:#f8fafc }

  .font-bungee { font-family:'Bungee', cursive }
  
  .day-tab.active { background:#eab308; color:#000 }
  
  .hero-gradient {
    background:
      linear-gradient(180deg, rgba(15,23,42,0.2) 0%, rgba(15,23,42,1) 100%),
      url('https://images.unsplash.com/photo-1595764430585-52114e796126?auto=format&fit=crop&q=80&w=2000');
    background-size: cover;
    background-position: center;
    height: 50vh;
  }

  .title-glow {
    text-shadow:
      0 0 20px rgba(234,179,8,0.6),
      0 5px 15px rgba(234,179,8,0.4);
  }
</style>
</head>

<body class="antialiased">

<header class="relative hero-gradient flex items-center justify-center text-center px-4">
  <div class="z-10 mt-16">
    <h1 class="text-5xl md:text-8xl font-bungee text-yellow-400 title-glow mb-4">
      Cine de Verano
    </h1>
    <p class="text-lg md:text-2xl font-light tracking-[0.25em] uppercase text-slate-200">
      Para que luego os quejéis
    </p>
  </div>
</header>

<main class="max-w-6xl mx-auto px-6 py-12">

<section class="mb-10 text-center">
  <div id="days-nav" class="flex gap-4 justify-center flex-wrap"></div>
</section>

<section class="mb-16">
  <h2 id="current-day-title" class="text-3xl font-bold mb-6"></h2>
  <!-- Aquí: mobile-first será una lista vertical con cards en horizontal; en md+ vuelve a grid de 3 columnas -->
  <div id="movies-grid" class="flex flex-col gap-6 md:grid md:grid-cols-3"></div>
</section>

<section class="bg-slate-900 p-8 rounded-3xl border border-yellow-500/20">
  <h2 class="font-bungee text-yellow-500 text-2xl mb-6">
    <i class="fas fa-tools mr-2"></i>Panel de Control
  </h2>

  <div class="grid md:grid-cols-2 gap-8">
    <div>
      <input id="new-day-label" placeholder="Ej: Día 3 - Domingo" class="w-full p-2 rounded bg-slate-800 border border-slate-600 mb-3">
      <button id="add-day-btn" class="w-full bg-slate-700 hover:bg-slate-600 p-2 rounded font-bold">
        Añadir día
      </button>
    </div>

    <div>
      <select id="movie-day-select" class="w-full p-2 rounded bg-slate-800 border border-slate-600 mb-2"></select>
      <input id="new-movie-title" placeholder="Título" class="w-full p-2 rounded bg-slate-800 border border-slate-600 mb-2">
      <input id="new-movie-time" placeholder="Hora (22:00)" class="w-full p-2 rounded bg-slate-800 border border-slate-600 mb-2">
      <textarea id="new-movie-desc" placeholder="Descripción" class="w-full p-2 rounded bg-slate-800 border border-slate-600 mb-3"></textarea>
      <button id="add-movie-btn" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black p-2 rounded font-black">
        Añadir película
      </button>
    </div>
  </div>
</section>

</main>

<footer class="text-center py-8 text-slate-500 text-sm">
© 2025 Cine de Verano
</footer>

<script type="module">
/* ========= OMDb ========= */
const OMDB_API_KEY = "8b02fcfe";
async function fetchMovieData(title) {
  try {
    const r = await fetch(
      `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&t=${encodeURIComponent(title)}`
    );
    const d = await r.json();

    if (d.Response === "True") {
      return {
        img: d.Poster && d.Poster !== "N/A"
          ? d.Poster
          : "https://images.unsplash.com/photo-1485846234645-a62644f84728",
        rating: d.imdbRating && d.imdbRating !== "N/A"
          ? d.imdbRating
          : null
      };
    }
  } catch {}

  return {
    img: "https://images.unsplash.com/photo-1485846234645-a62644f84728",
    rating: null
  };
}

/* ========= FIREBASE ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDRztedy1U_erKHDY94KlUkxcZNwQcDUZw",
  authDomain: "cine-verano.firebaseapp.com",
  projectId: "cine-verano",
  appId: "1:725171854528:web:a7ca7cd58ee3e024226125"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const docRef = doc(db, "cine-verano", "schedule");

let schedule = [];
let currentDay = 0;
let uid = null;

/* ========= DOM ========= */
const newDayLabel = document.getElementById("new-day-label");
const movieDaySelect = document.getElementById("movie-day-select");
const newMovieTitle = document.getElementById("new-movie-title");
const newMovieTime = document.getElementById("new-movie-time");
const newMovieDesc = document.getElementById("new-movie-desc");

/* ========= AUTH ========= */
signInAnonymously(auth);
onAuthStateChanged(auth, user => {
  if (user) {
    uid = user.uid;
    init();
  }
});

function init() {
  onSnapshot(docRef, snap => {
    if (snap.exists()) schedule = snap.data().list;
    else {
      schedule = [{ label: "Día 1 - Viernes", movies: [] }];
      setDoc(docRef, { list: schedule });
    }
    render();
  });
}

/* ========= RENDER ========= */
function render() {
  const nav = document.getElementById("days-nav");
  const sel = movieDaySelect;
  nav.innerHTML = sel.innerHTML = "";

  schedule.forEach((d, i) => {
    nav.innerHTML += `
      <button onclick="changeDay(${i})"
        class="day-tab px-4 py-2 rounded-full border ${i === currentDay ? 'active' : 'border-slate-600'}">
        ${d.label}
      </button>`;
    sel.innerHTML += `<option value="${i}">${d.label}</option>`;
  });

  const day = schedule[currentDay];
  document.getElementById("current-day-title").innerText = day.label;
  const grid = document.getElementById("movies-grid");
  grid.innerHTML = "";

  day.movies.forEach((m, idx) => {
      const votes = m.votes ? Object.keys(m.votes).length : 0;
      const voted = m.votes && m.votes[uid];

      grid.innerHTML += `
        <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 flex flex-row md:flex-col items-center md:items-stretch">
          <img src="${m.img}" class="w-28 h-40 ml-4 mt-4 mb-4 rounded-lg md:m-0 md:rounded-none md:w-full md:aspect-[2/3] object-cover bg-black">

          <div class="p-4 flex-1 w-full">
            <div class="flex items-start justify-between gap-4">
              <span class="bg-yellow-500 text-black px-3 py-1 rounded text-xs font-black">${m.time}</span>
            </div>

            <h3 class="text-xl font-bold mt-2">${m.title}</h3>

            ${m.rating ? `
              <div class="text-yellow-400 font-bold mt-1 flex items-center gap-1">
                <i class="fas fa-star"></i> IMDb ${m.rating}/10
              </div>` : ""}

            <p class="text-slate-400 italic text-sm mt-2">${m.desc}</p>

            <button
              onclick="toggleVote(${currentDay}, ${idx})"
              class="mt-4 w-full flex items-center justify-center gap-2 px-3 py-2 rounded
                ${voted ? 'bg-green-600' : 'bg-slate-700 hover:bg-slate-600'}">
              <i class="fas fa-thumbs-up"></i>
              <span>${votes}</span>
            </button>
          </div>
        </div>`;
    });
}

window.changeDay = i => { currentDay = i; render(); };

/* ========= VOTOS ========= */
window.toggleVote = async (d, m) => {
  const movie = schedule[d].movies[m];
  if (!movie.votes) movie.votes = {};

  if (movie.votes[uid]) delete movie.votes[uid];
  else movie.votes[uid] = true;

  await setDoc(docRef, { list: schedule });
};

/* ========= ADD DAY ========= */
document.getElementById("add-day-btn").onclick = async () => {
  if (!newDayLabel.value) return;
  schedule.push({ label: newDayLabel.value, movies: [] });
  newDayLabel.value = "";
  await setDoc(docRef, { list: schedule });
};

/* ========= ADD MOVIE ========= */
document.getElementById("add-movie-btn").onclick = async () => {
  const d = movieDaySelect.value;
  const t = newMovieTitle.value;
  const h = newMovieTime.value;
  const de = newMovieDesc.value;
  if (!t || !h) return;

  const data = await fetchMovieData(t);

  schedule[d].movies.push({
    title: t,
    time: h,
    img: data.img,
    rating: data.rating,
    desc: de,
    votes: {}
  });

  newMovieTitle.value = "";
  newMovieTime.value = "";
  newMovieDesc.value = "";

  await setDoc(docRef, { list: schedule });
};
</script>

</body>
</html>
