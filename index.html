<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cine de Verano</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
@import url('https://fonts.googleapis.com/css2?family=Bungee&family=Inter:wght@300;400;700&display=swap');
  body { font-family: 'Inter', sans-serif; background:#0f172a; color:#f8fafc }
  .font-bungee { font-family:'Bungee', cursive }
  .day-tab.active { background:#eab308; color:#000 }
  .hero-gradient {
    background:
      linear-gradient(180deg, rgba(15,23,42,0.2) 0%, rgba(15,23,42,1) 100%),
      url('https://images.unsplash.com/photo-1595764430585-52114e796126?auto=format&fit=crop&q=80&w=2000');
    background-size: cover;
    background-position: center;
    height: 50vh;
  }
  .title-glow { text-shadow:0 0 20px rgba(234,179,8,0.6),0 5px 15px rgba(234,179,8,0.4); }
  header.is-logged-in { height: 60px !important; background: none !important; }

  #current-day-title {
      font-size: 1.875rem; 
      line-height: 2.25rem;
  }

  @media (min-width: 768px) {
      #current-day-title {
          font-size: 2.25rem; 
      }
  }

  #navbar-content {
      background-color: #1e293b !important; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.18);
  }

  .time-badge {
    font-size: 0.8rem !important; 
    padding: 3px 10px !important;
    font-weight: 700 !important; 
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 45px;
    text-transform: uppercase;
  }

  .time-badge.text-custom {
      font-size: 0.7rem !important;
      font-weight: 600 !important;
      letter-spacing: 0.02em;
  }

  .movie-title {
      display: block;
      overflow: visible;
      white-space: normal;
  }
</style>
</head>

<body class="antialiased">

<header id="main-header" class="relative hero-gradient flex items-center justify-center text-center px-4 transition-all duration-500">
  <div id="hero-content" class="z-10 mt-16">
    <h1 class="text-5xl md:text-8xl font-bungee text-yellow-400 title-glow mb-4">Cine de Verano</h1>
    <p class="text-lg md:text-2xl font-light tracking-[0.25em] uppercase text-slate-200">Para que luego os quejéis</p>
  </div>

  <div id="navbar-content" class="hidden fixed top-0 left-0 w-full z-50 px-6 py-3 flex items-center justify-between border-b border-yellow-500/20 backdrop-blur-md">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 bg-yellow-500 rounded flex items-center justify-center text-black">
        <i class="fas fa-film"></i>
      </div>
      <span class="font-bungee text-yellow-500 text-lg tracking-wider">Cine de Verano</span>
    </div>
    <button class="text-white text-2xl p-2 hover:bg-slate-800 rounded transition-colors">
      <i class="fas fa-bars"></i>
    </button>
  </div>
</header>

<main class="max-w-6xl mx-auto px-6 py-12">

  <div id="admin-login-panel" class="max-w-md mx-auto bg-slate-900 p-6 rounded-xl border border-yellow-500/20 mb-6 shadow-2xl">
    <h3 class="text-yellow-500 font-bungee text-xl mb-4 text-center">Inicia sesión</h3>
    <input id="admin-email" placeholder="Email" class="w-full p-3 rounded bg-slate-800 border border-slate-700 mb-3 text-white">
    <input id="admin-password" type="password" placeholder="Contraseña" class="w-full p-3 rounded bg-slate-800 border border-slate-700 mb-4 text-white">
    <button id="admin-login-btn" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black p-3 rounded font-bold transition-all">Entrar como admin</button>
  </div>

  <div id="main-content" class="hidden">
    
    <section class="mb-16">
      <div class="relative inline-block mb-8">
        <button id="current-day-title" onclick="toggleMenu()" class="text-4xl font-bold flex items-center gap-3 hover:text-yellow-400 transition-colors">
          <span></span>
          <i class="fas fa-chevron-down text-xl text-yellow-500"></i>
        </button>

        <div id="dropdown-menu" class="hidden absolute left-0 mt-2 w-64 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl z-50 overflow-hidden">
          <div id="dropdown-list" class="flex flex-col"></div>
        </div>
      </div>

      <div id="movies-grid" class="flex flex-col gap-6 md:grid md:grid-cols-3"></div>
    </section>

    <section id="control-panel" class="hidden bg-slate-900 p-8 rounded-3xl border border-yellow-500/20">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-bungee text-yellow-500 text-2xl">
          <i class="fas fa-tools mr-2"></i>Panel de Control
        </h2>
        <button id="admin-logout-btn" class="bg-slate-700 hover:bg-slate-600 text-white p-2 rounded font-bold">Cerrar sesión</button>
      </div>

      <div class="grid md:grid-cols-2 gap-8">
        <div>
          <input id="new-category-label" placeholder="Ej: Día 20, Recomendaciones, ..." class="w-full p-2 rounded bg-slate-800 border border-slate-600 mb-3">
          <button id="add-category-btn" class="w-full bg-slate-700 hover:bg-slate-600 p-2 rounded font-bold">Añadir categoría</button>
        </div>
        <div>
          <select id="movie-day-select" class="w-full p-2 rounded bg-slate-800 border border-slate-600 mb-2"></select>
          <input id="new-movie-title" placeholder="Título" class="w-full p-2 rounded bg-slate-800 border border-slate-600 mb-2">
          <input id="new-movie-details" placeholder="Ej: 22:00, Temporada 1, ..." class="w-full p-2 rounded bg-slate-800 border border-slate-600 mb-2">
          <button id="add-movie-btn" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black p-2 rounded font-black">Añadir película</button>
        </div>
      </div>
    </section>
  </div>
</main>

<footer class="text-center py-8 text-slate-500 text-sm">
  <p>© 2025 Cine de Verano</p>
  <p id="user-id-display" class="mt-2 text-[10px] opacity-50 font-mono uppercase tracking-widest"></p>
</footer>

<script type="module">
/* ========== IMPORTS FIREBASE ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ========== FIREBASE CONFIG ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDRztedy1U_erKHDY94KlUkxcZNwQcDUZw",
  authDomain: "cine-verano.firebaseapp.com",
  projectId: "cine-verano",
  appId: "1:725171854528:web:a7ca7cd58ee3e024226125"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========== ESTADO GLOBAL ========== */
let schedule = [];
let currentDay = 0;
let uid = null;
let isAdminFlag = false;
let userGroups = [];
let selectedGroup = null;
let docRef = null;
let unsubscribeSchedule = null;

/* ========== FUNCIONES AUX ========== */
async function getUserGroups(uid) {
  const q = query(collection(db, "groups"), where("members", "array-contains", uid));
  const snap = await getDocs(q);
  return snap.docs.map(d => d.id);
}

async function isAdminByGroup(uid) {
  if (!uid) return false;

  const groupsSnap = await getDocs(collection(db, "groups"));

  for (const groupDoc of groupsSnap.docs) {
    const members = groupDoc.data().members || [];
    if (members.includes(uid)) return true;
  }

  return false;
}

/* ========== ADMIN LOGIN / LOGOUT ========== */
document.getElementById("admin-login-btn").onclick = async () => {
  const email = document.getElementById("admin-email").value;
  const password = document.getElementById("admin-password").value;
  try {
    const cred = await signInWithEmailAndPassword(auth, email, password);
    // onAuthStateChanged gestionará la UI al autenticarse
  } catch (err) {
    console.error(err);
    alert("Credenciales incorrectas o usuario no admin.");
  }
};

document.getElementById("admin-logout-btn").onclick = async () => {
  await signOut(auth);
  alert("Sesión cerrada");
};

/* ========== OMDb ========== */
const OMDB_API_KEY = "8b02fcfe";
async function fetchMovieData(title) {
  try {
    const r = await fetch(`https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&t=${encodeURIComponent(title)}`);
    const d = await r.json();
    if (d.Response === "True") {
      return {
        img: d.Poster && d.Poster !== "N/A" ? d.Poster : "https://images.unsplash.com/photo-1485846234645-a62644f84728",
        rating: d.imdbRating && d.imdbRating !== "N/A" ? d.imdbRating : null
      };
    }
  } catch (e) {
    console.error("OMDb error", e);
  }
  return { img: "https://images.unsplash.com/photo-1485846234645-a62644f84728", rating: null };
}

/* ========== INIT: escucha schedule ========= */
function init() {
  if (!docRef) return;

  // cerrar listener anterior
  if (unsubscribeSchedule) unsubscribeSchedule();
  unsubscribeSchedule = onSnapshot(docRef, snap => {
    schedule = snap.exists()
      ? snap.data().list
      : [{ label: "Día 1", movies: [] }];
    render();
  });
}

init();

/* ========== AUTH STATE CHANGES ========= */
onAuthStateChanged(auth, async (user) => {
  const loginPanel = document.getElementById("admin-login-panel");
  const controlPanel = document.getElementById("control-panel");
  const mainContent = document.getElementById("main-content"); 
  
  const mainHeader = document.getElementById("main-header");
  const heroContent = document.getElementById("hero-content");
  const navbarContent = document.getElementById("navbar-content");

  if (!user) {
    uid = null;
    isAdminFlag = false;
    
    // MODO LOGIN: Solo se ve el panel de login y el Hero gigante
    loginPanel.classList.remove("hidden");
    mainContent.classList.add("hidden"); 
    controlPanel.classList.add("hidden");
    
    mainHeader.classList.remove("is-logged-in");
    heroContent.classList.remove("hidden");
    navbarContent.classList.add("hidden");
    return;
  }

  uid = user.uid;
  userGroups = await getUserGroups(uid);
  isAdminFlag = userGroups.length > 0;

  if (isAdminFlag) {
    selectedGroup = userGroups[0];
    docRef = doc(db, "cine-verano", selectedGroup);
    
    // MODO APP: Se oculta login y se muestra la cartelera
    loginPanel.classList.add("hidden");
    mainContent.classList.remove("hidden"); 
    controlPanel.classList.remove("hidden");
    
    mainHeader.classList.add("is-logged-in");
    heroContent.classList.add("hidden");
    navbarContent.classList.remove("hidden");
    
    init();
  } else {
    alert("Usuario sin permisos.");
    await signOut(auth);
  }
});

/* ========== RENDER ========= */
/* VOTOS */
window.toggleVote = async (d, m) => {
  if (!isAdminFlag || !uid || !docRef) return;
  
  const movie = schedule[d].movies[m];
  if (!movie.votes) movie.votes = {};
  
  if (movie.votes[uid]) {
    delete movie.votes[uid];
  } else {
    movie.votes[uid] = true;
  }
  
  await setDoc(docRef, { list: schedule });
};

/* RENDER */
function render() {
  const titleContainer = document.getElementById("current-day-title").querySelector('span');
  const dropdownList = document.getElementById("dropdown-list");
  const daySelect = document.getElementById("movie-day-select"); 
  
  const day = schedule[currentDay];
  titleContainer.innerText = day ? day.label : (selectedGroup || "");

  // 1. Menú Desplegable y Selector de días del panel
  dropdownList.innerHTML = "";
  daySelect.innerHTML = ""; 
  
  if (userGroups.length > 1) {
    dropdownList.innerHTML += `<div class="bg-slate-800 px-4 py-1 text-[10px] uppercase font-bold text-slate-500 tracking-widest">Cambiar Grupo</div>`;
    userGroups.forEach(g => {
      dropdownList.innerHTML += `
        <button onclick="changeGroup('${g}')" class="px-4 py-2 text-left hover:bg-slate-700 text-sm ${g === selectedGroup ? 'text-yellow-500' : 'text-slate-300'}">
          <i class="fas fa-users mr-2 opacity-50"></i>${g}
        </button>`;
    });
    dropdownList.innerHTML += `<div class="border-t border-slate-700 my-1"></div>`;
  }
  
  dropdownList.innerHTML += `<div class="bg-slate-800 px-4 py-1 text-[10px] uppercase font-bold text-slate-500 tracking-widest">Días / Cartelera</div>`;
  schedule.forEach((d, i) => {
    dropdownList.innerHTML += `
      <button onclick="changeDay(${i})" class="px-4 py-3 text-left hover:bg-slate-800 border-b border-slate-800 last:border-0 ${i === currentDay ? 'text-yellow-400 font-bold' : 'text-white'}">
        <i class="fas fa-calendar-day mr-2 opacity-50"></i>${d.label}
      </button>`;
    
    daySelect.innerHTML += `<option value="${i}">${d.label}</option>`;
  });

  // 2. Grid de Películas
  const grid = document.getElementById("movies-grid");
  grid.innerHTML = "";
  
  if (day && day.movies) {
    day.movies.forEach((m, idx) => {
      const votes = m.votes ? Object.keys(m.votes).length : 0;
      const voted = uid && m.votes && m.votes[uid];
      const isTime = /^[\d:.]+$/.test(m.time); 
      const extraClass = isTime ? '' : 'text-custom';

      grid.innerHTML += `
        <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 flex flex-row md:flex-col items-center md:items-stretch shadow-xl transition-transform hover:scale-[1.01]">
          <img src="${m.img}" class="w-28 h-40 ml-4 mt-4 mb-4 rounded-lg md:m-0 md:rounded-none md:w-full md:aspect-[2/3] object-cover bg-black">
          <div class="p-4 flex-1 w-full">
            <span class="time-badge ${extraClass} bg-yellow-500 text-black rounded uppercase">${m.time}</span>
            <h3 class="text-xl font-bold mt-2 leading-tight">${m.title}</h3>
            ${m.rating ? `<div class="text-yellow-400 font-bold mt-1 flex items-center gap-1 text-sm"><i class="fas fa-star"></i> IMDb ${m.rating}/10</div>` : ""}
            <button onclick="toggleVote(${currentDay},${idx})" class="mt-4 w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg font-bold transition-all ${voted ? 'bg-green-600' : 'bg-slate-700 hover:bg-slate-600'}">
              <i class="fas fa-thumbs-up"></i><span>${votes}</span>
            </button>
          </div>
        </div>`;
    });
  }
}

// FUNCIONES DE CONTROL
window.toggleMenu = () => {
  const menu = document.getElementById("dropdown-menu");
  menu.classList.toggle("hidden");
};

window.changeDay = (i) => {
  currentDay = i;
  document.getElementById("dropdown-menu").classList.add("hidden");
  render();
};

window.changeGroup = (groupName) => {
  selectedGroup = groupName;
  docRef = doc(db, "cine-verano", selectedGroup);
  document.getElementById("dropdown-menu").classList.add("hidden");
  init(); // Reinicia el listener de Firebase para el nuevo grupo
};

// Cerrar menú si se hace clic fuera
window.addEventListener('click', (e) => {
  if (!document.getElementById('current-day-title').contains(e.target)) {
    document.getElementById('dropdown-menu').classList.add('hidden');
  }
});

window.changeDay = i => { currentDay = i; render(); };

/* ========== VOTOS: SOLO ADMINS PUEDEN VOTAR ========== */
window.toggleVote = async (d,m) => {
  if (!isAdminFlag || !uid) { alert("Solo los administradores pueden votar."); return; }
  const movie = schedule[d].movies[m];
  if (!movie.votes) movie.votes = {};
  if (movie.votes[uid]) delete movie.votes[uid];
  else movie.votes[uid] = true;
  await setDoc(docRef, { list: schedule });
  render();
};

/* ========== ADD DAY / MOVIE: SOLO ADMINS ========= */
document.getElementById("add-category-btn").onclick = async () => {
  if (!isAdminFlag) { alert("Solo los administradores pueden añadir categorías."); return; }
  const label = document.getElementById("new-category-label").value;
  if (!label) return;
  schedule.push({ label, movies: [] });
  document.getElementById("new-category-label").value = "";
  await setDoc(docRef, { list: schedule });
};

document.getElementById("add-movie-btn").onclick = async () => {
  if (!isAdminFlag) { alert("Solo los administradores pueden añadir películas."); return; }
  const d = document.getElementById("movie-day-select").value;
  const t = document.getElementById("new-movie-title").value;
  const h = document.getElementById("new-movie-details").value;
  if (!t || !h) return;
  const data = await fetchMovieData(t);
  schedule[d].movies.push({ title: t, time: h, img: data.img, rating: data.rating, votes: {} });
  document.getElementById("new-movie-title").value = "";
  document.getElementById("new-movie-details").value = "";
  await setDoc(docRef, { list: schedule });
};
</script>

</body>
</html>
